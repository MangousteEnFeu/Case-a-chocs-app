# ============================================
# Case à Chocs Connector - Docker Compose
# ============================================
# 
# Usage:
#   Démarrer (mode local):    docker-compose up -d
#   Démarrer (Supabase):      Remplir .env puis docker-compose up -d app
#   Arrêter:                  docker-compose down
#   Voir logs:                docker-compose logs -f
#   Rebuild:                  docker-compose up -d --build
#
# Par défaut: PostgreSQL local inclus
# Optionnel: Supabase si .env configuré
#
# ============================================

services:
  # ===========================================
  # Base de données locale (par défaut)
  # ===========================================
  postgres:
    image: postgres:16-alpine
    container_name: case-a-chocs-db
    environment:
      POSTGRES_DB: casachocs
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      TZ: Europe/Zurich
    ports:
      - "5432:5432"
    volumes:
        - postgres_data:/var/lib/postgresql/data
        - ./create_table.sql:/docker-entrypoint-initdb.d/01-schema.sql
        - ./insert_demo_data.sql:/docker-entrypoint-initdb.d/02-demo-data.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================
  # Application (Backend + Frontend intégré)
  # ===========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: case-a-chocs-connector
    ports:
      - "8080:8080"
    environment:
      # Database: utilise .env si défini, sinon PostgreSQL local
      - SPRING_DATASOURCE_URL=${DATABASE_URL:-jdbc:postgresql://postgres:5432/casachocs}
      - SPRING_DATASOURCE_USERNAME=${DATABASE_USER:-postgres}
      - SPRING_DATASOURCE_PASSWORD=${DATABASE_PASSWORD:-postgres}

      # Configuration PETZI
      - PETZI_WEBHOOK_SECRET=${PETZI_WEBHOOK_SECRET:-AEeyJhbGciOiJIUzUxMiIsImlzcyI6}

      # JVM Options
      - JAVA_OPTS=-Xmx512m -Xms256m

    depends_on:
      postgres:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Restart automatique
    restart: unless-stopped

volumes:
  postgres_data: